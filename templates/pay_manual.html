{% extends "base.html" %}
{% block content %}
<div class="max-w-2xl mx-auto bg-white rounded-2xl shadow p-5">

  <h2 class="text-2xl font-semibold mb-1">Pagamento via Pix</h2>
  <p class="text-sm text-zinc-500 mb-4">{{ purchase.show_name }}</p>

  <div class="p-3 rounded-xl bg-yellow-100 border border-yellow-300 text-yellow-900 mb-4">
    <div class="font-semibold">Aguardando pagamento‚Ä¶</div>
    <div class="text-sm text-yellow-900/80">
      Fa√ßa o Pix e envie o comprovante. Ap√≥s confirma√ß√£o, enviaremos os ingressos por WhatsApp ou e-mail em at√© <b>72 horas</b>.
    </div>
  </div>

  {# valores vindos do backend (ENV) #}
  {% set unit_brl = unit_price_brl if unit_price_brl is defined else 50.00 %}
  {% set qty = ticket_qty if ticket_qty is defined else 0 %}
  {% set total_price = (payment.amount_cents or 0) / 100 %}

  <div class="text-sm text-zinc-700 space-y-1 mb-4">
    <div><span class="font-semibold">Comprador:</span> {{ purchase.buyer_name }}</div>

    <div><span class="font-semibold">Ingressos:</span> {{ qty }}</div>
    <div><span class="font-semibold">Valor unit√°rio:</span> R$ {{ '%.2f'|format(unit_brl) }}</div>

    <div class="text-base font-semibold">
      Total: R$ {{ '%.2f'|format(total_price) }}
    </div>

    <div class="text-xs text-zinc-500 break-all">
      <span class="font-semibold">Token da compra:</span> {{ purchase.token }}
    </div>
  </div>

  {% if pix_key %}
    <div class="rounded-xl border p-4">
      <div class="font-semibold mb-2">Chave Pix</div>
      <div class="text-xs text-zinc-500 break-all mb-2">{{ pix_key }}</div>

      <button type="button"
        class="w-full rounded-xl border py-3 font-medium hover:bg-zinc-50"
        onclick="navigator.clipboard.writeText('{{ pix_key }}'); alert('Chave Pix copiada ‚úÖ');"
      >
        Copiar chave Pix
      </button>
    </div>
  {% endif %}

  {% if qr_image_url %}
    <div class="my-5 flex justify-center">
      <img src="{{ qr_image_url }}" alt="QR Code Pix" class="w-64 h-64 border rounded-xl">
    </div>
  {% endif %}

  {# Mensagem do WhatsApp #}
  {% set wa_text =
    "Ol√°! Acabei de fazer o Pix do Sons & Sabores ‚úÖ\n\n" ~
    "üìå Para confirmar, por favor:\n" ~
    "1) Anexe o comprovante nesta conversa\n" ~
    "2) Envie a mensagem\n\n" ~
    "Show: " ~ purchase.show_name ~ "\n" ~
    "Comprador: " ~ purchase.buyer_name ~ "\n" ~
    "Ingressos: " ~ qty ~ " √ó R$ " ~ ('%.2f'|format(unit_brl)) ~ "\n" ~
    "Valor total: R$ " ~ ('%.2f'|format(total_price)) ~ "\n" ~
    "Token da compra: " ~ purchase.token ~ "\n\n" ~
    "Os ingressos ser√£o enviados em at√© 72 horas."
  %}
  {% set wa_link = "https://wa.me/" ~ whatsapp_number ~ "?text=" ~ wa_text|urlencode %}

  <div class="mt-4 grid gap-2">
    <a href="{{ wa_link }}" target="_blank" rel="noopener"
       class="inline-flex w-full justify-center rounded-xl bg-black text-white py-3 font-medium">
      Enviar comprovante no WhatsApp
    </a>

    <a href="{{ url_for('purchase.pay_manual_thanks', token=purchase.token) }}"
       class="inline-flex w-full justify-center rounded-xl border py-3 font-medium hover:bg-zinc-50">
      J√° enviei o comprovante
    </a>

    <button type="button" class="rounded-xl border py-3 font-medium hover:bg-zinc-50"
            onclick="navigator.clipboard.writeText('{{ purchase.token }}'); alert('Token copiado ‚úÖ');">
      Copiar token da compra
    </button>

    <button type="button" class="rounded-xl border py-3 font-medium hover:bg-zinc-50"
            onclick="navigator.clipboard.writeText(`{{ wa_text|replace('`','') }}`); alert('Mensagem copiada ‚úÖ');">
      Copiar mensagem para WhatsApp
    </button>
  </div>

  <!-- ‚úÖ UPLOAD DO COMPROVANTE -->
  <div class="mt-6 rounded-xl border p-4">
    <div class="font-semibold mb-1">Enviar comprovante aqui (mais f√°cil)</div>
    <p class="text-sm text-zinc-600 mb-3">
      Se preferir, envie o comprovante por aqui. A confirma√ß√£o e envio dos ingressos ocorre em at√© <b>72 horas</b>.
    </p>

    <form method="post"
          action="{{ url_for('purchase.upload_receipt', token=purchase.token) }}"
          enctype="multipart/form-data"
          class="space-y-3">

      <input type="file" name="receipt_file" required
             accept="image/*,application/pdf"
             class="w-full rounded-xl border p-3 text-sm bg-white">

      <button type="submit"
              class="w-full rounded-xl bg-black text-white py-3 font-medium">
        Enviar comprovante
      </button>

      <p class="text-xs text-zinc-500">
        Formatos aceitos: imagem ou PDF. Tamanho m√°ximo: {{ max_mb }}MB.
      </p>
    </form>
  </div>

  <div class="mt-4 text-center text-xs text-zinc-500">
    Depois de enviar o comprovante, voc√™ pode fechar esta p√°gina.
  </div>

</div>
{% endblock %}
