{% extends "base.html" %}
{% block content %}

<div class="max-w-2xl mx-auto bg-white rounded-2xl shadow p-5">
  <h2 class="text-2xl font-semibold mb-1">Sons & Sabores</h2>
  <p class="text-sm text-zinc-500 mb-4">Compra de ingressos</p>

  <form method="POST" action="{{ url_for('purchase.buy_post', event_slug=event.slug) }}" class="space-y-4">

    <div>
      <label class="text-sm text-zinc-600">Show</label>
      <select name="show_name" class="w-full rounded-xl border p-3 text-sm" required>
        <option value="">Selecioneâ€¦</option>
        {% for s in (config.SHOWS if config and config.SHOWS else []) %}
          <option value="{{ s }}">{{ s }}</option>
        {% endfor %}
      </select>
      <p class="text-xs text-zinc-500 mt-1">Escolha o show para esta compra.</p>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <div>
        <label class="text-sm text-zinc-600">Nome do comprador</label>
        <input name="buyer_name" class="w-full rounded-xl border p-3 text-sm" required />
      </div>
      <div>
        <label class="text-sm text-zinc-600">CPF do comprador</label>
        <input name="buyer_cpf" class="w-full rounded-xl border p-3 text-sm" required />
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <div>
        <label class="text-sm text-zinc-600">E-mail</label>
        <input name="buyer_email" type="email" class="w-full rounded-xl border p-3 text-sm" />
      </div>
      <div>
        <label class="text-sm text-zinc-600">Telefone</label>
        <input name="buyer_phone" class="w-full rounded-xl border p-3 text-sm" />
      </div>
    </div>

    <div>
      <label class="text-sm text-zinc-600">Convidados (1 por linha ou separado por vÃ­rgula/;)</label>
      <textarea id="guests_text" name="guests_text" rows="5"
                class="w-full rounded-xl border p-3 text-sm"
                placeholder="Ex: Maria&#10;JoÃ£o&#10;Ana, Pedro; Carla"></textarea>
      <p class="text-xs text-zinc-500 mt-1">
        O comprador jÃ¡ conta como 1 pessoa. Aqui vocÃª adiciona as demais.
      </p>
    </div>

    <!-- âœ… PREVIEW DO TOTAL -->
    <div class="rounded-2xl border p-4 bg-zinc-50">
      <div class="text-sm text-zinc-700 space-y-1">
        <div><span class="font-semibold">Valor por pessoa:</span> <span id="unit_price_lbl">R$ 50,00</span></div>
        <div><span class="font-semibold">Total de pessoas:</span> <span id="total_people_lbl">1</span></div>
        <div class="text-base">
          <span class="font-semibold">Total a pagar:</span> <span id="total_price_lbl">R$ 50,00</span>
        </div>
      </div>
      <p class="text-xs text-zinc-500 mt-2">
        Esta Ã© uma prÃ©via. O valor final Ã© calculado no servidor.
      </p>
    </div>

    <button type="submit" class="w-full rounded-xl bg-black text-white py-3 font-medium">
      Ir para pagamento
    </button>

  </form>
</div>

<script>
  // ðŸ”§ pega do backend via env (render) se vocÃª quiser:
  // Como template nÃ£o lÃª env direto, deixo default 100 (R$1,00).
  // Se quiser passar esse valor do Flask pro template, eu te mostro.
  const ticketPriceCents = 100;

  function parseGuests(raw) {
    raw = (raw || "").trim();
    if (!raw) return [];

    const lines = raw.split(/\r?\n/);
    let names = [];

    for (const line of lines) {
      const cleaned = (line || "").trim();
      if (!cleaned) continue;

      // separa por ; e ,
      const parts = cleaned.replace(/;/g, ",").split(",");
      for (const p of parts) {
        const name = (p || "").trim();
        if (name) names.push(name);
      }
    }
    return names;
  }

  function formatBRLFromCents(cents) {
    const v = (cents / 5000).toFixed(2).replace(".", ",");
    return "R$ " + v;
  }

  function updatePreview() {
    const guestsRaw = document.getElementById("guests_text").value;
    const guests = parseGuests(guestsRaw);
    const totalPeople = 1 + guests.length;
    const totalCents = totalPeople * ticketPriceCents;

    document.getElementById("unit_price_lbl").textContent = formatBRLFromCents(ticketPriceCents);
    document.getElementById("total_people_lbl").textContent = String(totalPeople);
    document.getElementById("total_price_lbl").textContent = formatBRLFromCents(totalCents);
  }

  document.getElementById("guests_text").addEventListener("input", updatePreview);
  updatePreview();
</script>

{% endblock %}
