{% extends "base.html" %}
{% block content %}

<div class="max-w-2xl mx-auto bg-white rounded-2xl shadow p-5">
  <h2 class="text-2xl font-semibold mb-1">Sons & Sabores</h2>
  <p class="text-sm text-zinc-500 mb-4">Compra de ingressos</p>

  <form method="POST" action="{{ url_for('purchase.buy_post', event_slug=event.slug) }}" class="space-y-4">

    <div>
      <label class="text-sm text-zinc-600">Show</label>
      <select id="show_name" name="show_name" class="w-full rounded-xl border p-3 text-sm" required>
        <option value="">Selecione…</option>
        {% for s in (config.SHOWS if config and config.SHOWS else []) %}
          <option value="{{ s }}">{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <div>
        <label class="text-sm text-zinc-600">Nome do comprador</label>
        <input name="buyer_name" class="w-full rounded-xl border p-3 text-sm" required />
      </div>

      <div>
        <label class="text-sm text-zinc-600">CPF do comprador</label>
        <input
          id="cpf"
          name="buyer_cpf"
          inputmode="numeric"
          placeholder="000.000.000-00"
          maxlength="14"
          class="w-full rounded-xl border p-3 text-sm"
          required
        />
        <p id="cpf_hint" class="text-xs text-zinc-500 mt-1"></p>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <div>
        <label class="text-sm text-zinc-600">E-mail</label>
        <input name="buyer_email" type="email" class="w-full rounded-xl border p-3 text-sm" />
      </div>

      <div>
        <label class="text-sm text-zinc-600">Telefone</label>
        <input
          id="phone"
          name="buyer_phone"
          inputmode="tel"
          placeholder="(31) 9 9999-9999"
          maxlength="16"
          class="w-full rounded-xl border p-3 text-sm"
        />
        <p id="phone_hint" class="text-xs text-zinc-500 mt-1"></p>
      </div>
    </div>

    <div>
      <label class="text-sm text-zinc-600">Acompanhantes (linha ou separado por vírgula/;)</label>
      <textarea id="guests_text" name="guests_text" rows="5"
                class="w-full rounded-xl border p-3 text-sm"
                placeholder="Ex: Maria&#10;João&#10;Ana, Pedro; Carla"></textarea>
      <p class="text-xs text-zinc-500 mt-1">
        O comprador já conta como 1 ingresso.
      </p>
    </div>

    <!-- ✅ PREVIEW DO TOTAL (por show) -->
    <div class="rounded-2xl border p-4 bg-zinc-50">
      <div class="text-sm text-zinc-700 space-y-1">
        <div><span class="font-semibold">Valor por ingresso:</span> <span id="unit_price_lbl">—</span></div>
        <div><span class="font-semibold">Total de ingressos:</span> <span id="total_people_lbl">1</span></div>
        <div class="text-base">
          <span class="font-semibold">Total a pagar:</span> <span id="total_price_lbl">—</span>
        </div>
      </div>
      <p class="text-xs text-zinc-500 mt-2">
        Prévia calculada automaticamente. O valor final é validado no servidor.
      </p>
    </div>

    <button type="submit" class="w-full rounded-xl bg-black text-white py-3 font-medium">
      Ir para pagamento
    </button>

  </form>
</div>

<script>
  // ✅ fallback geral (ENV)
  const fallbackPriceCents = {{ ticket_price_cents|default(5000) }};
  // ✅ preços por show vindos do backend
  const showPrices = {{ show_prices_map|default({})|tojson }};

  function parseGuests(raw) {
    raw = (raw || "").trim();
    if (!raw) return [];
    const lines = raw.split(/\r?\n/);
    let names = [];
    for (const line of lines) {
      const cleaned = (line || "").trim();
      if (!cleaned) continue;
      const parts = cleaned.replace(/;/g, ",").split(",");
      for (const p of parts) {
        const name = (p || "").trim();
        if (name) names.push(name);
      }
    }
    return names;
  }

  function formatBRLFromCents(cents) {
    const v = (cents / 100).toFixed(2).replace(".", ",");
    return "R$ " + v;
  }

  function getSelectedPriceCents() {
    const sel = document.getElementById("show_name");
    const name = sel ? sel.value : "";
    return (showPrices[name] || fallbackPriceCents);
  }

  function updatePreview() {
    const unitCents = getSelectedPriceCents();
    const guestsRaw = document.getElementById("guests_text").value;
    const guests = parseGuests(guestsRaw);
    const totalPeople = 1 + guests.length;
    const totalCents = totalPeople * unitCents;

    document.getElementById("unit_price_lbl").textContent = formatBRLFromCents(unitCents);
    document.getElementById("total_people_lbl").textContent = String(totalPeople);
    document.getElementById("total_price_lbl").textContent = formatBRLFromCents(totalCents);
  }

  document.getElementById("guests_text").addEventListener("input", updatePreview);
  document.getElementById("show_name").addEventListener("change", updatePreview);
  updatePreview();
</script>

<!-- ✅ máscara + validação CPF/telefone (seu script original) -->
<script>
  function onlyDigits(v) { return (v || "").replace(/\D/g, ""); }

  function maskCPF(value) {
    const d = onlyDigits(value).slice(0, 11);
    if (d.length <= 3) return d;
    if (d.length <= 6) return d.replace(/(\d{3})(\d+)/, "$1.$2");
    if (d.length <= 9) return d.replace(/(\d{3})(\d{3})(\d+)/, "$1.$2.$3");
    return d.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
  }

  function maskPhone(value) {
    const d = onlyDigits(value).slice(0, 11);
    if (d.length <= 2) return d;
    if (d.length <= 6) return d.replace(/(\d{2})(\d+)/, "($1) $2");
    if (d.length === 11) return d.replace(/(\d{2})(\d{1})(\d{4})(\d{4})/, "($1) $2 $3-$4");
    return d.replace(/(\d{2})(\d{4})(\d{4})/, "($1) $2-$3");
  }

  function isValidCPF(cpfDigits) {
    const cpf = onlyDigits(cpfDigits);
    if (cpf.length !== 11) return false;
    if (/^(\d)\1{10}$/.test(cpf)) return false;

    let sum = 0;
    for (let i = 0; i < 9; i++) sum += parseInt(cpf[i], 10) * (10 - i);
    let d1 = (sum * 10) % 11;
    if (d1 === 10) d1 = 0;
    if (d1 !== parseInt(cpf[9], 10)) return false;

    sum = 0;
    for (let i = 0; i < 10; i++) sum += parseInt(cpf[i], 10) * (11 - i);
    let d2 = (sum * 10) % 11;
    if (d2 === 10) d2 = 0;
    if (d2 !== parseInt(cpf[10], 10)) return false;

    return true;
  }

  function setFieldState(input, hintEl, ok, msg) {
    if (!input) return;
    input.classList.remove("border-red-400", "border-green-400", "ring-2", "ring-red-200", "ring-green-200");
    if (ok === null) {
      if (hintEl) hintEl.textContent = msg || "";
      if (hintEl) hintEl.className = "text-xs text-zinc-500 mt-1";
      return;
    }
    if (ok) {
      input.classList.add("border-green-400", "ring-2", "ring-green-200");
      if (hintEl) hintEl.textContent = msg || "Ok ✅";
      if (hintEl) hintEl.className = "text-xs text-green-700 mt-1";
    } else {
      input.classList.add("border-red-400", "ring-2", "ring-red-200");
      if (hintEl) hintEl.textContent = msg || "Verifique este campo.";
      if (hintEl) hintEl.className = "text-xs text-red-700 mt-1";
    }
  }

  const cpfInput = document.getElementById("cpf");
  const phoneInput = document.getElementById("phone");
  const cpfHint = document.getElementById("cpf_hint");
  const phoneHint = document.getElementById("phone_hint");

  if (cpfInput) {
    cpfInput.addEventListener("input", () => {
      cpfInput.value = maskCPF(cpfInput.value);
      const d = onlyDigits(cpfInput.value);

      if (d.length === 0) return setFieldState(cpfInput, cpfHint, null, "");
      if (d.length < 11) return setFieldState(cpfInput, cpfHint, null, "Digite os 11 dígitos do CPF.");

      const ok = isValidCPF(d);
      setFieldState(cpfInput, cpfHint, ok, ok ? "CPF válido ✅" : "CPF inválido. Confira os números.");
    });

    cpfInput.addEventListener("blur", () => {
      const d = onlyDigits(cpfInput.value);
      if (d.length === 11) {
        const ok = isValidCPF(d);
        setFieldState(cpfInput, cpfHint, ok, ok ? "CPF válido ✅" : "CPF inválido. Confira os números.");
      }
    });
  }

  if (phoneInput) {
    phoneInput.addEventListener("input", () => {
      phoneInput.value = maskPhone(phoneInput.value);
      const d = onlyDigits(phoneInput.value);

      if (d.length === 0) return setFieldState(phoneInput, phoneHint, null, "");
      if (d.length < 10) return setFieldState(phoneInput, phoneHint, false, "Telefone incompleto (mín. 10 dígitos com DDD).");

      setFieldState(phoneInput, phoneHint, true, "Telefone ok ✅");
    });

    phoneInput.addEventListener("blur", () => {
      const d = onlyDigits(phoneInput.value);
      if (d.length > 0 && d.length < 10) {
        setFieldState(phoneInput, phoneHint, false, "Telefone incompleto (mín. 10 dígitos com DDD).");
      }
    });
  }
</script>

{% endblock %}
