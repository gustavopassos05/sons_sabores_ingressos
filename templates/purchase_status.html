{% extends "base.html" %}
{% block content %}
<div class="max-w-xl mx-auto bg-white rounded-2xl shadow p-6 text-center">

  <h2 class="text-2xl font-semibold mb-1">Sons & Sabores</h2>
  <p class="text-sm text-zinc-500 mb-4">{{ purchase.show_name }}</p>

  {% set st = (purchase.status or '')|lower %}

  {% if st == 'reservation_pending' %}
    <div class="p-3 rounded-xl bg-blue-50 border border-blue-200 text-blue-900 mb-4">
      <div class="font-semibold">Reserva registrada ✅</div>
      <div class="text-sm text-blue-900/80">
        Vamos confirmar sua reserva e enviar a confirmação por e-mail/WhatsApp em até <b>3 dias</b>.
      </div>
    </div>

  {% elif st == 'reservation_pending_price' %}
    <div class="p-3 rounded-xl bg-yellow-50 border border-yellow-200 text-yellow-900 mb-4">
      <div class="font-semibold">Reserva registrada ✅</div>
      <div class="text-sm text-yellow-900/80">
        Este show ainda está com o preço em definição. Assim que definirmos, enviaremos as instruções (pagamento/confirmação) por e-mail/WhatsApp em até <b>3 dias</b>.
      </div>
    </div>

  {% elif st == 'pending_payment' %}
    <div class="p-3 rounded-xl bg-yellow-50 border border-yellow-200 text-yellow-900 mb-4">
      <div class="font-semibold">Aguardando pagamento…</div>
      <div class="text-sm text-yellow-900/80">
        Faça o pagamento e envie o comprovante. Após confirmação, enviaremos os ingressos por WhatsApp ou e-mail em até <b>3 dias</b>.
      </div>
    </div>

  {% elif st == 'paid' %}
    <div class="p-3 rounded-xl bg-green-50 border border-green-200 text-green-900 mb-4">
      <div class="font-semibold">Pagamento confirmado ✅</div>
      <div class="text-sm text-green-900/80">
        Seus ingressos serão enviados por WhatsApp ou e-mail em até <b>3 dias</b>.
      </div>
    </div>

  {% elif st == 'reserved' %}
    <div class="p-3 rounded-xl bg-green-50 border border-green-200 text-green-900 mb-4">
      <div class="font-semibold">Reserva confirmada ✅</div>
      <div class="text-sm text-green-900/80">
        Sua reserva está confirmada. Qualquer atualização será enviada por e-mail/WhatsApp.
      </div>
    </div>

  {% else %}
    <div class="p-3 rounded-xl bg-zinc-50 border border-zinc-200 text-zinc-800 mb-4">
      <div class="font-semibold">Status da solicitação</div>
      <div class="text-sm text-zinc-700/80">
        Estamos processando sua solicitação. Em caso de dúvidas, entre em contato com a equipe.
      </div>
    </div>
  {% endif %}

  <div class="rounded-xl border p-4 text-left text-sm text-zinc-700 space-y-2">
    <div><span class="font-semibold">Comprador:</span> {{ purchase.buyer_name }}</div>
    {% if purchase.buyer_email %}<div><span class="font-semibold">E-mail:</span> {{ purchase.buyer_email }}</div>{% endif %}
    {% if purchase.buyer_phone %}<div><span class="font-semibold">Telefone:</span> {{ purchase.buyer_phone }}</div>{% endif %}
    <div><span class="font-semibold">Pessoas:</span> {{ purchase.ticket_qty or 1 }}</div>

    {% if purchase.ticket_unit_price_cents and purchase.ticket_unit_price_cents > 0 %}
      <div>
        <span class="font-semibold">Valor por pessoa:</span>
        R$ {{ '%.2f'|format((purchase.ticket_unit_price_cents or 0)/100) }}
      </div>
    {% endif %}

    {% if payment and payment.amount_cents %}
      <div class="font-semibold">
        Total: R$ {{ '%.2f'|format((payment.amount_cents or 0)/100) }}
      </div>
    {% endif %}

    <div class="text-xs text-zinc-500 break-all"><span class="font-semibold">Token:</span> {{ purchase.token }}</div>
  </div>

  {% if st == 'pending_payment' %}
    <div class="mt-4 grid gap-2">
      <a href="{{ url_for('purchase.pay_manual', token=purchase.token) }}"
         class="rounded-xl bg-black text-white py-3 font-medium">
        Enviar comprovante / ver dados do Pix
      </a>
    </div>
  {% elif st in ['reservation_pending', 'reservation_pending_price', 'reserved', 'paid'] %}
    {# ✅ não tem pagamento manual aqui #}
    <div class="mt-4 grid gap-2">
      {% set wa_text = ("Olá! Fiz uma reserva no Sons & Sabores ✅\n"
                        ~ "Show: " ~ purchase.show_name ~ "\n"
                        ~ "Nome: " ~ purchase.buyer_name ~ "\n"
                        ~ "Pessoas: " ~ (purchase.ticket_qty or 1) ~ "\n"
                        ~ "Token: " ~ purchase.token) %}
      {% set wa_link = "https://wa.me/" ~ whatsapp_number ~ "?text=" ~ wa_text|urlencode %}
      <a href="{{ wa_link }}" target="_blank" rel="noopener"
         class="rounded-xl border py-3 font-medium hover:bg-zinc-50 text-center">
        Falar com a equipe no WhatsApp
      </a>

      <a class="btn" target="_blank"
         href="{{ url_for('whats.whats_borogodo_purchase', token=purchase.token) }}">
        Enviar para o Borogodó (WhatsApp)
      </a>

      <a class="btn" target="_blank"
         href="{{ url_for('whats.whats_cliente_purchase', token=purchase.token) }}">
        Enviar confirmação para o cliente
      </a>


      <a class="btn" target="_blank"
         href="{{ url_for('whats.whats_cliente', reserva_id=reserva.id) }}">
        Enviar confirmação para o cliente
      </a>

    </div>
  {% endif %}


  <div class="mt-4 text-center text-xs text-zinc-500">
    Você pode fechar esta página com segurança.
  </div>

</div>
{% endblock %}
