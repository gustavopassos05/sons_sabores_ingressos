{% extends "admin_base.html" %}
{% block admin_content %}

<div class="bg-white rounded-2xl shadow p-5">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
    <div>
      <h2 class="text-xl font-semibold">Compras</h2>
      <p class="text-sm text-zinc-500">VisÃ£o por compra (PDF/ZIP + confirmaÃ§Ã£o manual).</p>
    </div>

    <form method="get" class="flex gap-2">
      <input name="q" value="{{ q }}" class="w-full sm:w-80 rounded-xl border p-3 text-sm"
             placeholder="Buscar por nome, CPF, show, tokenâ€¦">
      <button class="rounded-xl bg-black text-white px-5 text-sm">Buscar</button>
    </form>
  </div>

  <div class="rounded-xl border bg-white divide-y">

    {# âœ… CabeÃ§alho/descriÃ§Ã£o das colunas (desktop) #}
    <div class="hidden md:grid grid-cols-7 gap-3 bg-zinc-50 text-sm text-zinc-600 p-3 font-medium">
      <div>Show</div>
      <div>Comprador</div>
      <div>Data / Token</div>
      <div>Contato</div>
      <div>Pagamento</div>
      <div>Links / E-mail</div>
      <div>AÃ§Ãµes</div>
    </div>

    {% for row in rows %}
      {% set p = row.purchase %}
      {% set pay = row.payment %}
      {% set status = (pay.status if pay else 'n/d') %}
      {% set provider = (pay.provider if pay else '') %}
      {% set total = (pay.amount_cents if pay else 0) / 100 %}
      {% set pdf_all = (pay.tickets_pdf_url if pay else '') %}
      {% set zip_all = (pay.tickets_zip_url if pay else '') %}

      <div class="p-4 grid grid-cols-1 md:grid-cols-7 gap-3 text-sm">

        <!-- Show + qtd -->
        <div>
          <div class="text-xs text-zinc-400 md:hidden">Show</div>
          <div class="font-medium">{{ p.show_name }}</div>
          <div class="text-xs text-zinc-500">Ingressos gerados: {{ row.ticket_count }}</div>
        </div>

        <!-- Comprador -->
        <div>
          <div class="text-xs text-zinc-400 md:hidden">Comprador</div>
          <div class="font-medium">{{ p.buyer_name }}</div>
          {% if p.buyer_cpf %}<div class="text-xs text-zinc-500">CPF: {{ p.buyer_cpf }}</div>{% endif %}
        </div>

        <!-- Data -->
        <div>
          <div class="text-xs text-zinc-400 md:hidden">Data / Token</div>
          <div class="font-medium">
            {% if p.created_at %}{{ p.created_at.strftime('%d/%m/%Y %H:%M') }}{% else %}â€”{% endif %}
          </div>
          <div class="text-xs text-zinc-500">Token:</div>
          <div class="text-xs break-all">{{ p.token }}</div>
        </div>

        <!-- Contato -->
        <div>
          <div class="text-xs text-zinc-400 md:hidden">Contato</div>
          <div class="text-xs text-zinc-700 break-all">
            <span class="font-semibold">Email:</span>
            {{ p.buyer_email or "â€”" }}
          </div>
          <div class="text-xs text-zinc-700 break-all mt-1">
            <span class="font-semibold">Tel:</span>
            {{ p.buyer_phone or "â€”" }}
          </div>
        </div>

        <!-- Pagamento -->
        <div>
          <div class="text-xs text-zinc-400 md:hidden">Pagamento</div>
          <div class="flex items-center gap-2">
            {% if status|lower == 'paid' %}
              <span class="inline-block rounded-full bg-green-100 text-green-800 text-xs px-2 py-1">Pago</span>
            {% elif status|lower == 'n/d' %}
              <span class="inline-block rounded-full bg-zinc-100 text-zinc-700 text-xs px-2 py-1">n/d</span>
            {% else %}
              <span class="inline-block rounded-full bg-yellow-100 text-yellow-800 text-xs px-2 py-1">{{ status }}</span>
            {% endif %}
          </div>
          {% if provider %}<div class="text-xs text-zinc-500 mt-1">{{ provider }}</div>{% endif %}
          <div class="text-xs text-zinc-500 mt-1">Total: <span class="font-semibold">R$ {{ '%.2f'|format(total) }}</span></div>

          {# âœ… Status de envio do e-mail de ingressos (se existir payment) #}
          {% if pay and pay.tickets_email_sent_at %}
            <div class="text-xs text-green-700 mt-2">
              ðŸ“§ Enviado: {{ pay.tickets_email_sent_at.strftime('%d/%m %H:%M') }}
            </div>
            <div class="text-xs text-zinc-500 break-all">
              Para: {{ pay.tickets_email_sent_to }}
            </div>
          {% else %}
            <div class="text-xs text-zinc-500 mt-2">ðŸ“§ NÃ£o enviado</div>
          {% endif %}

          {% if pay and pay.tickets_email_last_error %}
            <div class="text-xs text-red-700 mt-1 break-all">
              Erro: {{ pay.tickets_email_last_error }}
            </div>
          {% endif %}
        </div>

        <!-- Links -->
        <div class="flex flex-col gap-2">
          <div class="text-xs text-zinc-400 md:hidden">Links / E-mail</div>

          {% if pdf_all %}
            <a href="{{ pdf_all }}" target="_blank" class="rounded-xl border px-3 py-2 text-xs text-center hover:bg-zinc-50">
              PDF (todos)
            </a>
          {% else %}
            <div class="text-xs text-zinc-400">PDF â€”</div>
          {% endif %}

          {% if zip_all %}
            <a href="{{ zip_all }}" target="_blank" class="rounded-xl border px-3 py-2 text-xs text-center hover:bg-zinc-50">
              ZIP (todos)
            </a>
          {% else %}
            <div class="text-xs text-zinc-400">ZIP â€”</div>
          {% endif %}

          <button type="button"
                  class="rounded-xl border px-3 py-2 text-xs hover:bg-zinc-50"
                  onclick="copyText('{{ zip_all or pdf_all or '' }}')">
            Copiar link
          </button>

          {% if p.buyer_email %}
            <form method="post" action="{{ url_for('admin_purchases.admin_send_purchase_email_buyer', purchase_id=p.id) }}">
              <button class="rounded-xl border px-3 py-2 text-xs hover:bg-zinc-50 w-full">
                Enviar para email do comprador
              </button>
            </form>
          {% else %}
            <div class="text-xs text-zinc-400">Sem e-mail do comprador</div>
          {% endif %}
        </div>

        <!-- AÃ§Ãµes -->
        <div class="flex flex-col gap-2">
          <div class="text-xs text-zinc-400 md:hidden">AÃ§Ãµes</div>

          {% if status|lower != 'paid' %}
            <button type="button"
                    class="rounded-xl bg-black text-white px-3 py-2 text-xs"
                    onclick="confirmPaid('{{ p.token }}')">
              Confirmar pagamento
            </button>
          {% endif %}

          {# âœ… Excluir compra #}
          <form method="post"
                action="{{ url_for('admin_delete.delete_purchase', token=p.token, next=request.full_path) }}"
                onsubmit="return confirm('Excluir a COMPRA inteira? Isso apaga pagamentos e todos os ingressos.');">
            <button class="rounded-xl border px-3 py-2 text-xs hover:bg-zinc-50 w-full">
              Excluir compra
            </button>
          </form>
        </div>

      </div>
    {% endfor %}

    {% if rows|length == 0 %}
      <div class="p-6 text-center text-zinc-500">Nenhuma compra encontrada.</div>
    {% endif %}
  </div>
</div>

<script>
  async function confirmPaid(purchaseToken) {
    if (!confirm("Confirmar pagamento e gerar ingressos?")) return;
    const res = await fetch("/admin/mark-paid/" + purchaseToken, { method: "POST" });
    if (res.ok) {
      alert("Pagamento confirmado âœ… Ingressos gerados/FTP em andamento.");
      window.location.reload();
    } else {
      alert("Erro ao confirmar pagamento. Veja logs.");
    }
  }

  function copyText(txt) {
    if (!txt) { alert("Sem link ainda."); return; }
    navigator.clipboard.writeText(txt);
    alert("Link copiado âœ…");
  }
</script>

{% endblock %}
