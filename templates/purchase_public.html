{% extends "base.html" %}
{% block content %}

<div class="max-w-2xl mx-auto bg-white rounded-2xl shadow p-5">

  <h2 class="text-2xl font-semibold mb-1">Sons & Sabores</h2>
  <p class="text-sm text-zinc-500 mb-4">{{ purchase.show_name }}</p>

  {% set st = (payment.status if payment else "")|lower %}

  {% if payment and st == "paid" %}
    {% if payment.tickets_pdf_url or payment.tickets_zip_url %}
      <div class="bg-white rounded-2xl shadow p-4 mb-4 flex flex-col gap-2 items-center text-center">
        <p class="text-green-700 font-medium">Ingressos liberados âœ…</p>

        <div class="flex flex-col sm:flex-row gap-2 w-full justify-center mt-2">
          {% if payment.tickets_pdf_url %}
            <a href="{{ payment.tickets_pdf_url }}" target="_blank"
               class="inline-block rounded-xl bg-black text-white px-6 py-3 text-center">
              Baixar ingressos (PDF)
            </a>
          {% endif %}

          {% if payment.tickets_zip_url %}
            <a href="{{ payment.tickets_zip_url }}" target="_blank"
               class="inline-block rounded-xl border px-6 py-3 text-center">
              Baixar (ZIP)
            </a>
          {% endif %}
        </div>
      </div>
    {% else %}
      <div class="bg-white rounded-2xl shadow p-4 mb-4 text-center">
        <p class="text-green-700 font-medium">Pagamento confirmado âœ…</p>
        <p class="text-sm text-zinc-500 mt-1">Estamos gerando seus arquivos para downloadâ€¦</p>
        <p class="text-xs text-zinc-400 mt-2">Essa pÃ¡gina atualiza automaticamente.</p>
        <script>
          setTimeout(() => window.location.reload(), 3000);
        </script>
      </div>
    {% endif %}

  {% elif payment and st == "pending" %}
    <div class="bg-white rounded-2xl shadow p-4 mb-4 text-center">
      <p class="text-zinc-800 font-medium">Pagamento em processamento</p>
      <p class="text-sm text-zinc-500 mt-1">Assim que confirmar, os ingressos serÃ£o liberados automaticamente.</p>

      <div class="mt-3 flex flex-col sm:flex-row gap-2 justify-center">
        {% if payment.id %}
          <a href="{{ url_for('purchase.pay_pix', payment_id=payment.id) }}"
             class="inline-block rounded-xl bg-black text-white px-6 py-3 text-center">
            Voltar para o QR Code (PIX)
          </a>
        {% endif %}
        <a href="{{ url_for('purchase.pay_return', token=purchase.token) }}"
           class="inline-block rounded-xl border px-6 py-3 text-center">
          Ver status do pagamento
        </a>
      </div>

      <script>
        setTimeout(() => window.location.reload(), 5000);
      </script>
    </div>

  {% elif payment and (st == "failed" or st == "expired" or st == "canceled" or st == "cancelled") %}
    <div class="bg-white rounded-2xl shadow p-4 mb-4 text-center">
      <p class="text-red-700 font-medium">Pagamento nÃ£o concluÃ­do</p>
      <p class="text-sm text-zinc-500 mt-1">
        Esse pagamento foi finalizado como <span class="font-semibold">{{ payment.status }}</span>.
        Gere um novo para liberar os ingressos.
      </p>

      <div class="mt-3 flex flex-col sm:flex-row gap-2 justify-center">
        <a href="{{ url_for('purchase.buy', event_slug=purchase.event.slug if purchase.event else 'sons-e-sabores') }}"
           class="inline-block rounded-xl bg-black text-white px-6 py-3 text-center">
          Gerar novo pagamento
        </a>
        <a href="{{ url_for('purchase.pay_return', token=purchase.token) }}"
           class="inline-block rounded-xl border px-6 py-3 text-center">
          Ver status do pagamento
        </a>
      </div>
    </div>
  {% endif %}

  <div class="mb-4 text-sm text-zinc-700 space-y-1">
    <div><span class="font-semibold">Comprador:</span> {{ purchase.buyer_name }}</div>
    <div><span class="font-semibold">Ingressos:</span> {{ tickets|length }}</div>
  </div>

  <!-- ðŸ”¹ AÃ‡Ã•ES GERAIS -->
  <div class="mb-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
    <button
      onclick="enviarTodosWhatsApp()"
      class="rounded-xl bg-black text-white py-3 text-sm font-medium"
      {% if not (payment and st == "paid") %}disabled style="opacity:.5;cursor:not-allowed"{% endif %}
    >
      Enviar todos no WhatsApp
    </button>

    <button
      onclick="copiarListaLinks()"
      class="rounded-xl border py-3 text-sm hover:bg-zinc-50"
      {% if not (payment and st == "paid") %}disabled style="opacity:.5;cursor:not-allowed"{% endif %}
    >
      Copiar lista de links
    </button>
  </div>

  <div class="divide-y rounded-xl border">
    {% for ticket in tickets %}
      {% set ticket_url = url_for('ticket_public', token=ticket.token, _external=True) %}
      {% set wa_text = "Seu ingresso do Sons & Sabores (" ~ purchase.show_name ~ ") âœ…\n\n" ~
                       "Nome: " ~ ticket.person_name ~ "\n" ~
                       "Link do ingresso:\n" ~ ticket_url ~ "\n\n" ~
                       "Apresente o QR Code na entrada." %}
      {% set wa_link = "https://wa.me/?text=" ~ wa_text|urlencode %}

      <div class="p-4">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="font-semibold truncate">
              {{ ticket.person_name }}
              {% if ticket.person_type == 'buyer' %}
                <span class="text-xs text-zinc-500">(Comprador)</span>
              {% endif %}
            </div>
            <div class="text-xs text-zinc-500 break-all">
              {{ ticket_url }}
            </div>
          </div>

          <a
            href="{{ ticket_url }}"
            class="shrink-0 rounded-xl border px-4 py-2 text-sm hover:bg-zinc-50"
          >
            Ver ingresso
          </a>
        </div>

        <div class="mt-3 grid grid-cols-1 sm:grid-cols-4 gap-2">
          <a
            href="{{ url_for('ticket_png', token=ticket.token) }}?v=1"
            class="rounded-xl border px-4 py-2 text-sm hover:bg-zinc-50 text-center"
          >
            PNG
          </a>

          <a
            href="{{ url_for('ticket_pdf', token=ticket.token) }}"
            class="rounded-xl border px-4 py-2 text-sm hover:bg-zinc-50 text-center"
          >
            PDF
          </a>

          <button
            onclick="navigator.clipboard.writeText('{{ ticket_url }}')"
            class="rounded-xl border px-4 py-2 text-sm hover:bg-zinc-50"
          >
            Copiar link
          </button>

          <a
            href="{{ wa_link }}"
            target="_blank"
            rel="noopener"
            class="rounded-xl border px-4 py-2 text-sm hover:bg-zinc-50 text-center"
          >
            WhatsApp
          </a>
        </div>
      </div>
    {% endfor %}
  </div>

</div>

<script>
  function enviarTodosWhatsApp() {
    const links = [
      {% for ticket in tickets %}
        "{{ url_for('ticket_public', token=ticket.token, _external=True) }}",
      {% endfor %}
    ];

    links.forEach((link, i) => {
      const text =
        "Seu ingresso do Sons & Sabores âœ…\n\n" +
        "Link do ingresso:\n" + link + "\n\n" +
        "Apresente o QR Code na entrada.";

      const url = "https://wa.me/?text=" + encodeURIComponent(text);
      setTimeout(() => window.open(url, "_blank"), i * 400);
    });
  }

  function copiarListaLinks() {
    let texto = "Ingressos â€” Sons & Sabores ({{ purchase.show_name }})\n\n";

    {% for ticket in tickets %}
      texto += "â€¢ {{ ticket.person_name }}:\n";
      texto += "{{ url_for('ticket_public', token=ticket.token, _external=True) }}\n\n";
    {% endfor %}

    navigator.clipboard.writeText(texto);
    alert("Lista de links copiada âœ…");
  }
</script>

{% endblock %}
