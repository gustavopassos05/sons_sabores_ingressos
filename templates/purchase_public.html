{% extends "base.html" %}
{% block content %}

<div class="max-w-3xl mx-auto bg-white rounded-2xl shadow p-5">

  <h2 class="text-2xl font-semibold mb-1">Sons & Sabores</h2>
  <p class="text-sm text-zinc-500 mb-4">{{ purchase.show_name }}</p>

  {# status do pagamento #}
  {% set st = (payment.status if payment else "")|lower %}

  {% if st == "paid" %}
    <div class="p-3 rounded-xl bg-green-50 border border-green-200 text-green-900 mb-4">
      <div class="font-semibold">Pagamento confirmado ✅</div>
      <div class="text-sm text-green-900/80">
        Os ingressos já estão disponíveis.
      </div>

      {% if payment.tickets_pdf_url or payment.tickets_zip_url %}
        <div class="mt-3 flex flex-col sm:flex-row gap-2">
          {% if payment.tickets_pdf_url %}
            <a href="{{ payment.tickets_pdf_url }}" target="_blank" rel="noopener"
               class="rounded-xl border px-4 py-2 text-sm hover:bg-zinc-50 text-center">
              PDF (todos)
            </a>
          {% endif %}
          {% if payment.tickets_zip_url %}
            <a href="{{ payment.tickets_zip_url }}" target="_blank" rel="noopener"
               class="rounded-xl border px-4 py-2 text-sm hover:bg-zinc-50 text-center">
              ZIP (todos)
            </a>
          {% endif %}
        </div>
      {% endif %}
    </div>
  {% else %}
    <div class="p-3 rounded-xl bg-yellow-50 border border-yellow-200 text-yellow-900 mb-4">
      <div class="font-semibold">Pagamento em processamento…</div>
      <div class="text-sm text-yellow-900/80">
        Assim que confirmarmos, os ingressos serão liberados.
      </div>
    </div>
  {% endif %}

  <div class="text-sm text-zinc-700 space-y-1 mb-4">
    <div><span class="font-semibold">Comprador:</span> {{ purchase.buyer_name }}</div>
    {% if purchase.buyer_email %}<div><span class="font-semibold">Email:</span> {{ purchase.buyer_email }}</div>{% endif %}
    {% if purchase.buyer_phone %}<div><span class="font-semibold">Telefone:</span> {{ purchase.buyer_phone }}</div>{% endif %}
    <div><span class="font-semibold">Ingressos:</span> {{ tickets|length }}</div>
  </div>

  <div class="rounded-xl border divide-y">
    {% for t in tickets %}
      <div class="p-4">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="font-semibold truncate">
              {{ t.person_name }}
              <span class="text-xs text-zinc-500">
                ({{ 'Comprador' if t.person_type == 'buyer' else 'Acompanhante' }})
              </span>
            </div>
            <div class="text-xs text-zinc-500 break-all">
              ticket: {{ t.token }}
            </div>
          </div>
        </div>

        <div class="mt-3 flex flex-col sm:flex-row gap-2">
          {% if t.pdf_path %}
            <a href="{{ t.pdf_path }}" target="_blank" rel="noopener"
               class="rounded-xl border px-4 py-2 text-sm hover:bg-zinc-50 text-center">
              Baixar PDF
            </a>
          {% endif %}
          {% if t.png_path %}
            <a href="{{ t.png_path }}" target="_blank" rel="noopener"
               class="rounded-xl border px-4 py-2 text-sm hover:bg-zinc-50 text-center">
              Baixar PNG
            </a>
          {% endif %}
          {% if t.pdf_path or t.png_path %}
            <button type="button"
                    class="rounded-xl border px-4 py-2 text-sm hover:bg-zinc-50"
                    onclick="copyText('{{ t.pdf_path or t.png_path }}')">
              Copiar link
            </button>
          {% endif %}
        </div>
      </div>
    {% endfor %}

    {% if tickets|length == 0 %}
      <div class="p-4 text-sm text-zinc-500 text-center">
        Nenhum ingresso gerado ainda.
      </div>
    {% endif %}
  </div>

</div>

<script>
  function copyText(txt) {
    navigator.clipboard.writeText(txt);
    alert("Link copiado ✅");
  }
</script>

{% endblock %}
