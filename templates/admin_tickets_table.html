{% extends "admin_base.html" %}
{% block admin_content %}
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-5">

  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
    <div>
      <h2 class="text-2xl font-semibold">Admin · Ingressos</h2>
      <p class="text-sm text-zinc-500">Tabela restrita para confirmar pagamento e enviar ingressos.</p>
    </div>

    <form method="get" class="flex gap-2">
      <input type="text" name="q" value="{{ q }}"
             placeholder="Buscar por comprador, CPF, show, pessoa, token…"
             class="w-full sm:w-80 rounded-xl border p-3 text-sm"/>
      {% if admin_key %}<input type="hidden" name="key" value="{{ admin_key }}"/>{% endif %}
      <button class="rounded-xl bg-black text-white px-5 text-sm">Buscar</button>
    </form>
  </div>

  <!-- ✅ Sem barra de rolagem: cards no mobile, tabela no desktop -->
  <div class="rounded-xl border bg-white divide-y">

    <!-- Cabeçalho (apenas desktop) -->
    <div class="hidden md:grid grid-cols-6 gap-3 bg-zinc-50 text-sm text-zinc-600 p-3 font-medium">
      <div>Show</div>
      <div>Compra</div>
      <div>Pessoa</div>
      <div>Pagamento</div>
      <div>Links</div>
      <div>Ações</div>
    </div>

    {% for row in rows %}
      {% set t = row.ticket %}
      {% set p = row.purchase %}
      {% set pay = row.payment %}

      {% set buyer = (p.buyer_name if p else t.buyer_name) %}
      {% set cpf = (p.buyer_cpf if p else '') %}
      {% set purchase_token = (p.token if p else '') %}
      {% set pay_status = (pay.status if pay else 'n/d') %}
      {% set pay_provider = (pay.provider if pay else '') %}

      <div class="p-4 grid grid-cols-1 md:grid-cols-6 gap-3 text-sm">

        <!-- Show -->
        <div>
          <div class="md:hidden text-xs text-zinc-400 mb-1">Show</div>
          <div class="font-medium">{{ t.show_name }}</div>
        </div>

        <!-- Compra -->
        <div>
          <div class="md:hidden text-xs text-zinc-400 mb-1">Compra</div>
          <div class="font-medium">{{ buyer }}</div>
          {% if cpf %}<div class="text-xs text-zinc-500">CPF: {{ cpf }}</div>{% endif %}
          {% if purchase_token %}<div class="text-xs text-zinc-400 break-all">Token: {{ purchase_token }}</div>{% endif %}
        </div>

        <!-- Pessoa -->
        <div>
          <div class="md:hidden text-xs text-zinc-400 mb-1">Pessoa</div>
          <div class="font-semibold">{{ t.person_name }}</div>
          <div class="text-xs text-zinc-500">
            {{ 'Comprador' if t.person_type=='buyer' else 'Acompanhante' }}
          </div>
        </div>

        <!-- Pagamento -->
        <div>
          <div class="md:hidden text-xs text-zinc-400 mb-1">Pagamento</div>
          <div class="flex items-center gap-2">
            {% if pay_status|lower == 'paid' %}
              <span class="inline-block rounded-full bg-green-100 text-green-800 text-xs px-2 py-1">Pago</span>
            {% elif pay_status|lower == 'n/d' %}
              <span class="inline-block rounded-full bg-zinc-100 text-zinc-700 text-xs px-2 py-1">n/d</span>
            {% else %}
              <span class="inline-block rounded-full bg-yellow-100 text-yellow-800 text-xs px-2 py-1">{{ pay_status }}</span>
            {% endif %}
          </div>
          {% if pay_provider %}<div class="text-xs text-zinc-500 mt-1">{{ pay_provider }}</div>{% endif %}
        </div>

        <!-- Links -->
        <div>
          <div class="md:hidden text-xs text-zinc-400 mb-1">Links</div>
          <div class="flex flex-col gap-1">
            {% if t.pdf_path %}
              <a href="{{ t.pdf_path }}" target="_blank" class="underline text-xs break-all">PDF</a>
            {% else %}
              <span class="text-xs text-zinc-400">PDF —</span>
            {% endif %}
            {% if t.png_path %}
              <a href="{{ t.png_path }}" target="_blank" class="underline text-xs break-all">PNG</a>
            {% else %}
              <span class="text-xs text-zinc-400">PNG —</span>
            {% endif %}
          </div>
        </div>

        <!-- Ações -->
        <div>
          <div class="md:hidden text-xs text-zinc-400 mb-1">Ações</div>
          <div class="flex flex-col gap-2">

            {% if purchase_token and pay_status|lower != 'paid' %}
              <button type="button"
                      class="rounded-xl bg-black text-white px-3 py-2 text-xs"
                      onclick="confirmPaid('{{ purchase_token }}')">
                Confirmar pagamento
              </button>
            {% endif %}

            <button type="button"
                    class="rounded-xl border px-3 py-2 text-xs hover:bg-zinc-50"
                    onclick="copyText('{{ t.pdf_path or t.png_path or '' }}')">
              Copiar link
            </button>

            <button type="button"
                    class="rounded-xl border px-3 py-2 text-xs hover:bg-zinc-50"
                    onclick="sendWhats('{{ buyer|e }}','{{ t.show_name|e }}','{{ t.person_name|e }}','{{ t.pdf_path or t.png_path or '' }}')">
              WhatsApp
            </button>
            {% if p.buyer_email %}
              <form method="post" action="{{ url_for('admin_purchases.admin_send_purchase_email_buyer', purchase_id=p.id) }}">
                <button class="rounded-xl border px-3 py-2 text-xs hover:bg-zinc-50 w-full">
                  Enviar para email do comprador
                </button>
              </form>
            {% else %}
              <div class="text-xs text-zinc-400">Sem e-mail do comprador</div>
            {% endif %}

            <form method="post"
                  action="{{ url_for('admin_delete.delete_ticket', ticket_id=t.id) }}"
                  onsubmit="return confirm('Excluir este ingresso (apenas esta pessoa)?');">
              <button class="rounded-xl border px-3 py-2 text-xs hover:bg-zinc-50 w-full">
                Excluir ingresso
              </button>
            </form>

            {% if p and p.token %}
            <form method="post"
                  action="{{ url_for('admin_delete.delete_purchase', token=p.token) }}"
                  onsubmit="return confirm('Excluir a COMPRA inteira? Isso apaga pagamentos e todos os ingressos.');">
              <button class="rounded-xl border px-3 py-2 text-xs hover:bg-zinc-50 w-full">
                Excluir compra
              </button>
            </form>
            {% endif %}

          </div>
        </div>

      </div>
    {% endfor %}

    {% if rows|length == 0 %}
      <div class="p-6 text-center text-zinc-500">Nenhum registro encontrado.</div>
    {% endif %}

  </div>

</div>

<script>
  const ADMIN_KEY = "{{ admin_key }}";

  function copyText(txt) {
    if (!txt) { alert("Sem link ainda."); return; }
    navigator.clipboard.writeText(txt);
    alert("Link copiado ✅");
  }

  function sendWhats(buyer, show, person, link) {
    if (!link) { alert("Sem link ainda."); return; }
    const text =
      "Ingresso Sons & Sabores ✅\n\n" +
      "Show: " + show + "\n" +
      "Comprador: " + buyer + "\n" +
      "Pessoa: " + person + "\n\n" +
      "Link para baixar:\n" + link + "\n\n" +
      "Apresente o QR Code dentro do ingresso na entrada.";
    window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
  }

  async function confirmPaid(purchaseToken) {
    if (!confirm("Confirmar pagamento e gerar ingressos?")) return;

    const url = "/admin/mark-paid/" + purchaseToken + "?key=" + encodeURIComponent(ADMIN_KEY);
    const res = await fetch(url, { method: "POST" });

    if (res.ok) {
      alert("Pagamento confirmado ✅ Ingressos gerados/FTP em andamento.");
      window.location.reload();
    } else {
      alert("Erro ao confirmar pagamento. Veja logs.");
    }
  }
</script>
{% endblock %}
