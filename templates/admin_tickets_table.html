{% extends "base.html" %}
{% block content %}
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow p-5">

  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
    <div>
      <h2 class="text-2xl font-semibold">Admin · Ingressos</h2>
      <p class="text-sm text-zinc-500">Tabela restrita para confirmar pagamento e enviar ingressos.</p>
    </div>

    <form method="get" class="flex gap-2">
      <input type="text" name="q" value="{{ q }}"
             placeholder="Buscar por comprador, CPF, show, pessoa, token…"
             class="w-full sm:w-80 rounded-xl border p-3 text-sm"/>
      {% if admin_key %}<input type="hidden" name="key" value="{{ admin_key }}"/>{% endif %}
      <button class="rounded-xl bg-black text-white px-5 text-sm">Buscar</button>
    </form>
  </div>

  <div class="rounded-xl border bg-white">
  <div class="w-full overflow-x-auto">
    <table class="min-w-[1100px] w-full text-sm">
      <thead class="bg-zinc-50 text-zinc-600">
        <tr>
          <th class="text-left p-3">Show</th>
          <th class="text-left p-3">Compra</th>
          <th class="text-left p-3">Pessoa</th>
          <th class="text-left p-3">Pagamento</th>
          <th class="text-left p-3">Links</th>
          <th class="text-left p-3">Ações</th>
        </tr>
      </thead>

      <tbody class="divide-y">
        {% for row in rows %}
          {% set t = row.ticket %}
          {% set p = row.purchase %}
          {% set pay = row.payment %}

          {% set buyer = (p.buyer_name if p else t.buyer_name) %}
          {% set cpf = (p.buyer_cpf if p else '') %}
          {% set purchase_token = (p.token if p else '') %}
          {% set pay_status = (pay.status if pay else 'n/d') %}
          {% set pay_provider = (pay.provider if pay else '') %}

          <tr class="align-top">
            <td class="p-3 whitespace-nowrap">{{ t.show_name }}</td>

            <td class="p-3 whitespace-nowrap">
              <div class="font-medium">{{ buyer }}</div>
              {% if cpf %}<div class="text-xs text-zinc-500">CPF: {{ cpf }}</div>{% endif %}
              {% if purchase_token %}<div class="text-xs text-zinc-500 break-all">Token: {{ purchase_token }}</div>{% endif %}
            </td>

            <td class="p-3 whitespace-nowrap">
              <div class="font-semibold">{{ t.person_name }}</div>
              <div class="text-xs text-zinc-500">
                {{ 'Comprador' if t.person_type=='buyer' else 'Acompanhante' }}
              </div>
            </td>

            <td class="p-3 whitespace-nowrap">
              <div class="font-semibold">{{ pay_status }}</div>
              {% if pay_provider %}<div class="text-xs text-zinc-500">{{ pay_provider }}</div>{% endif %}
            </td>

            <td class="p-3">
              <div class="flex flex-col gap-1">
                {% if t.pdf_path %}
                  <a href="{{ t.pdf_path }}" target="_blank" class="underline text-xs break-all">PDF</a>
                {% else %}
                  <span class="text-xs text-zinc-400">PDF —</span>
                {% endif %}
                {% if t.png_path %}
                  <a href="{{ t.png_path }}" target="_blank" class="underline text-xs break-all">PNG</a>
                {% else %}
                  <span class="text-xs text-zinc-400">PNG —</span>
                {% endif %}
              </div>
            </td>

            <td class="p-3">
              <div class="flex flex-col gap-2">

                {% if purchase_token and pay_status|lower != 'paid' %}
                  <button class="rounded-xl bg-black text-white px-3 py-2 text-xs"
                          onclick="confirmPaid('{{ purchase_token }}')">
                    Confirmar pagamento
                  </button>
                {% endif %}

                <button class="rounded-xl border px-3 py-2 text-xs hover:bg-zinc-50"
                        onclick="copyText('{{ t.pdf_path or t.png_path or '' }}')">
                  Copiar link
                </button>

                <button class="rounded-xl border px-3 py-2 text-xs hover:bg-zinc-50"
                        onclick="sendWhats('{{ buyer|e }}','{{ t.show_name|e }}','{{ t.person_name|e }}','{{ t.pdf_path or t.png_path or '' }}')">
                  WhatsApp
                </button>

              </div>
            </td>
          </tr>
        {% endfor %}

        {% if rows|length == 0 %}
          <tr><td colspan="6" class="p-5 text-center text-zinc-500">Nenhum registro encontrado.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

</div>

<script>
  const ADMIN_KEY = "{{ admin_key }}";

  function copyText(txt) {
    if (!txt) { alert("Sem link ainda."); return; }
    navigator.clipboard.writeText(txt);
    alert("Link copiado ✅");
  }

  function sendWhats(buyer, show, person, link) {
    if (!link) { alert("Sem link ainda."); return; }
    const text =
      "Ingresso Sons & Sabores ✅\n\n" +
      "Show: " + show + "\n" +
      "Comprador: " + buyer + "\n" +
      "Pessoa: " + person + "\n\n" +
      "Link para baixar:\n" + link + "\n\n" +
      "Apresente o QR Code dentro do ingresso na entrada.";
    window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
  }

  async function confirmPaid(purchaseToken) {
    if (!confirm("Confirmar pagamento e gerar ingressos?")) return;

    const url = "/admin/mark-paid/" + purchaseToken + "?key=" + encodeURIComponent(ADMIN_KEY);
    const res = await fetch(url, { method: "POST" });

    if (res.ok) {
      alert("Pagamento confirmado ✅ Ingressos gerados/FTP em andamento.");
      window.location.reload();
    } else {
      alert("Erro ao confirmar pagamento. Veja logs.");
    }
  }
</script>
{% endblock %}
